{% extends "base.html" %} {% block head %}
<!-- Підключення датапікера -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/uk.js"></script>

<style>
  /* Стилі для розкладу */
  .schedule-table {
    border-collapse: collapse;
    width: 100%;
  }
  .schedule-table th,
  .schedule-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: center;
    vertical-align: middle;
  }
  .schedule-table th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 1;
  }
  .schedule-table .time-column {
    position: sticky;
    left: 0;
    background-color: #f8f9fa;
    z-index: 1;
    text-align: right;
    font-weight: bold;
  }
  .schedule-appointment {
    background-color: #e2f0d9;
    border-radius: 4px;
    padding: 4px;
    margin: -4px;
    cursor: pointer;
  }
  .schedule-appointment:hover {
    background-color: #c5e0b4;
  }
  .schedule-container {
    max-height: 80vh;
    overflow-y: auto;
  }
  /* Стилі для суб-слотів */
  .sub-slot-row {
    display: none; /* Приховано за замовчуванням */
  }
  .sub-slot-row.expanded {
    display: table-row; /* Показати, якщо розгорнуто */
  }
  /* Стиль для іконки-тригера */
  .toggle-icon {
    cursor: pointer;
    padding-right: 5px;
  }
  /* Стиль для 15-хвилинного часового слоту */
  .sub-slot-time {
    font-size: 0.9em;
    color: #6c757d;
  }
</style>
{% endblock %} {% block content %}
<div class="row mb-3">
  <div class="col-md-6">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left me-2"></i>Назад на головну
    </a>
  </div>
  <div class="col-md-6 text-end">
    <a
      href="{{ url_for('appointments.create', date=selected_date.strftime('%Y-%m-%d')) }}"
      class="btn btn-success"
    >
      <i class="fas fa-plus me-2"></i>Новий запис
    </a>
  </div>
</div>

<div class="card">
  <div
    class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
  >
    <h5 class="mb-0">
      <i class="fas fa-calendar-day me-2"></i>Розклад майстрів на {{
      selected_date.strftime('%d.%m.%Y') }}
    </h5>
    <div>
      <form id="dateForm" class="d-inline">
        <input
          type="text"
          id="datepicker"
          name="date"
          class="form-control d-inline"
          style="width: 150px"
          value="{{ selected_date.strftime('%Y-%m-%d') }}"
        />
        <input
          type="hidden"
          id="selected-date-input"
          value="{{ selected_date.strftime('%Y-%m-%d') }}"
        />
      </form>
    </div>
  </div>
  <div class="card-body p-2">
    <div class="schedule-container">
      <table class="schedule-table">
        <thead>
          <tr>
            <th class="time-column">Час</th>
            {% for master in masters %}
            <th data-master-id="{{ master.id }}">{{ master.full_name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for interval in time_intervals %}
          <!-- Основний 30-хвилинний рядок -->
          <tr data-interval="{{ interval.main_time.strftime('%H:%M') }}">
            <td class="time-column">
              <span
                class="toggle-icon"
                data-bs-toggle="collapse"
                data-target="sub-slots-{{ interval.main_time.strftime('%H%M') }}"
              >
                ▸
              </span>
              {{ interval.main_time.strftime('%H:%M') }}
            </td>
            {% for master in masters %}
            <td
              class="main-slot-cell"
              data-time="{{ interval.main_time.strftime('%H:%M') }}"
            ></td>
            {% endfor %}
          </tr>

          <!-- 15-хвилинні підслоти -->
          {% for sub_slot in interval.sub_slots %}
          <tr
            class="sub-slot-row {% if interval.expanded %}expanded{% endif %}"
            data-sub-slot="{{ sub_slot.strftime('%H:%M') }}"
            data-parent="{{ interval.main_time.strftime('%H%M') }}"
          >
            <td class="time-column sub-slot-time">
              {{ sub_slot.strftime('%H:%M') }}
            </td>
            {% for master in masters %}
            <td
              class="sub-slot-cell"
              data-time="{{ sub_slot.strftime('%H:%M') }}"
            >
              {% if schedule_data[master.id][sub_slot] and
              schedule_data[master.id][sub_slot]|length > 0 %} {% set
              appointment = schedule_data[master.id][sub_slot][0] %} {% if
              appointment.client_id in multi_booking_client_ids %} {% set
              extra_class = ' multi-booking' %} {% else %} {% set extra_class =
              '' %} {% endif %} {% if appointment.start_time.strftime('%H:%M')
              == sub_slot.strftime('%H:%M') %}
              <div
                class="schedule-appointment status-{{ appointment.payment_status }}{{ extra_class }}"
                onclick="window.location.href='{{ url_for('appointments.view', id=appointment.id) }}'"
              >
                <strong>{{ appointment.client.name }}</strong><br />
                <small
                  >{{ appointment.start_time.strftime('%H:%M') }} - {{
                  appointment.end_time.strftime('%H:%M') }}</small
                >
                {% if appointment.services %}
                <br />
                <small>
                  {% for service in appointment.services[:1] %} {{
                  service.service.name }} {% if loop.index <
                  appointment.services|length %} ... {% endif %} {% endfor %}
                </small>
                {% endif %} {% if appointment.amount_paid %}
                <br />
                <small class="fw-bold"
                  >{{ "%.2f"|format(appointment.amount_paid) }} грн</small
                >
                {% endif %}
              </div>
              {% endif %} {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %} {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Ініціалізація датапікера
    flatpickr("#datepicker", {
      dateFormat: "Y-m-d",
      locale: "uk",
      onChange: function (selectedDates, dateStr, instance) {
        // Автоматичне відправлення форми при зміні дати
        document.getElementById("dateForm").submit();
      },
    });
  });
</script>
<script src="{{ url_for('static', filename='js/schedule.js') }}"></script>
{% endblock %}
